<!DOCTYPE html>
<html>
<head>
    <title>Whisper Real-Time Transcription</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        button { margin-right: 1em; }
        #output {
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 1em;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <h1>üéôÔ∏è Whisper Real-Time Transcription</h1>
    <label for="deviceSelect">Select Input Device:</label>
    <select id="deviceSelect"></select>
    <button onclick="startWithDevice()">Start</button>
    <button onclick="stopTranscription()">Stop</button>
    <button onclick="exitApp()">Exit</button>
    <a href="/download" target="_blank"><button>Download Transcript</button></a>
    <pre id="output"></pre>

    <script>
        let socket = null;

        function loadDevices() {
            fetch('/devices')
                .then(res => res.json())
                .then(devices => {
                    const select = document.getElementById('deviceSelect');
                    devices.forEach(dev => {
                        const option = document.createElement('option');
                        option.value = dev.index;
                        option.text = dev.name;
                        select.appendChild(option);
                    });
                });
        }

        function startWithDevice() {
            const device = document.getElementById('deviceSelect').value;
            console.log("üéõÔ∏è Selected device:", device);
            
            connectSocket();  // ‚úÖ Connect socket BEFORE starting backend

            fetch('/start?device=' + device)
                .then(() => {
                    console.log("üöÄ Backend started");
                });
        }

        function connectSocket() {
            socket = io({ transports: ['polling'] });
            const output = document.getElementById('output');

            socket.on('connect', () => console.log("‚úÖ WebSocket connected"));
            socket.on('disconnect', () => console.log("‚ùå WebSocket disconnected"));

            socket.on('transcription', function(data) {
                console.log("üìù Received:", data.text);
                output.innerText += '\n' + data.text;
                output.scrollTop = output.scrollHeight;
            });

            socket.on('connect_error', (err) => {
                console.error("WebSocket connection failed:", err);
            });
        }

        function stopTranscription() {
            fetch('/stop').then(() => {
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
            });
        }

        function exitApp() {
            if (!confirm("Are you sure you want to stop recording and exit?")) return;

            const download = confirm("Do you want to download the transcript before exiting?");

            if (download) {
                const link = document.createElement('a');
                link.href = '/download';
                link.download = 'transcript.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Small delay to allow download to trigger before stopping the backend
            setTimeout(() => {
                fetch('/exit')
                    .then(() => {
                        window.location.href = "/goodbye";
                    });
            }, 1000); // 1 second delay to ensure download begins
        }


        window.onload = loadDevices;
    </script>
</body>
</html>
