<!DOCTYPE html>
<html>
<head>
    <title>Whisper Real-Time Transcription</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        button { margin-right: 1em; }
        .output-box {
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 1em;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            margin-top: 1em;
        }
    </style>
</head>
<body>
    <h1>ğŸ™ï¸ Whisper Real-Time Transcription</h1>

    <label for="deviceSelect">Select Input Device:</label>
    <select id="deviceSelect"></select>
    <button onclick="startWithDevice()">Start</button>
    <button onclick="stopTranscription()">Stop</button>
    <button onclick="exitApp()">Exit</button>
    <a href="/download" target="_blank"><button>Download Transcript</button></a>

    <!-- Whisper Raw Transcript -->
    <h2>ğŸ“ Raw Transcript (Whisper)</h2>
    <pre id="output" class="output-box"></pre>

    <!-- Mistral Cleaned Transcript -->
    <h2>âœ… Cleaned Transcript (Mistral)</h2>
    <pre id="mistralTranscript" class="output-box"></pre>

    <!-- Mistral Suggestions -->
    <h2>ğŸ’¡ Suggestions (Mistral)</h2>
    <pre id="mistralSuggestions" class="output-box"></pre>

    <script>
        let socket = null;

        function loadDevices() {
            fetch('/devices')
                .then(res => res.json())
                .then(devices => {
                    const select = document.getElementById('deviceSelect');
                    devices.forEach(dev => {
                        const option = document.createElement('option');
                        option.value = dev.index;
                        option.text = dev.name;
                        select.appendChild(option);
                    });
                });
        }

        function startWithDevice() {
            const device = document.getElementById('deviceSelect').value;
            console.log("ğŸ›ï¸ Selected device:", device);

            connectSocket(); // Connect WebSocket before starting backend

            fetch('/start?device=' + device)
                .then(() => console.log("ğŸš€ Backend started"));
        }

        function connectSocket() {
            socket = io({ transports: ['polling'] });

            const output = document.getElementById('output');
            const mistralTranscript = document.getElementById('mistralTranscript');
            const mistralSuggestions = document.getElementById('mistralSuggestions');

            socket.on('connect', () => console.log("âœ… WebSocket connected"));
            socket.on('disconnect', () => console.log("âŒ WebSocket disconnected"));

            socket.on('transcription', function(data) {
                console.log("ğŸ“ Received:", data.text);
                output.innerText += data.text;
                output.scrollTop = output.scrollHeight;
            });

            socket.on('mistral_transcript', function(data) {
                console.log("ğŸ“˜ Cleaned:", data.text);
                mistralTranscript.innerText += data.text;
                mistralTranscript.scrollTop = mistralTranscript.scrollHeight;
            });

            socket.on('mistral_suggestions', function(data) {
                console.log("ğŸ’¡ Suggestion:", data.text);
                mistralSuggestions.innerText += '\nâ€¢ ' + data.text;
                mistralSuggestions.scrollTop = mistralSuggestions.scrollHeight;
            });

            socket.on('connect_error', (err) => {
                console.error("WebSocket connection failed:", err);
            });
        }

        function stopTranscription() {
            fetch('/stop').then(() => {
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
            });
        }

        function exitApp() {
            if (!confirm("Are you sure you want to stop recording and exit?")) return;

            const download = confirm("Do you want to download the transcript before exiting?");
            if (download) {
                const link = document.createElement('a');
                link.href = '/download';
                link.download = 'transcript.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            setTimeout(() => {
                fetch('/exit')
                    .then(() => window.location.href = "/goodbye");
            }, 1000);
        }

        window.onload = loadDevices;
    </script>
</body>
</html>
